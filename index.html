<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="./css/styles.css">
    <title>Shop</title>
</head>
<body>
    <div id="main">
        <h1>Онлайн магазин</h1>
        <img src="https://cdn-icons-png.flaticon.com/512/3595/3595455.png">
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
    </div>
    <div id="city-buttons" class="city-buttons"></div>
    <div id="genres-list" class="genre-buttons"></div>
    <div id="subgenres-list" class="subgenre-list"></div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>

        fetch('/city')
            .then(response => {
                console.log(response);
                return response.json();
            })
            .then(cities => {
                const cityButtonsDiv = document.getElementById('city-buttons');
                cities.forEach(city => {
                    const cityButton = createCityButton(city);
                    cityButtonsDiv.appendChild(cityButton);
                });
            })
            .catch(error => {
                console.error('Ошибка при получении списка городов:', error);
            });


        function createCityButton(cityInfo) {
            const cityButton = document.createElement('button');
            cityButton.classList.add('city-button');

            const cityName = cityInfo.name;
            const emojiMatch = cityName.match(/(\p{Emoji_Presentation})/gu);
            const emoji = emojiMatch ? emojiMatch[0] : '';
            const cityNameWithoutEmoji = cityName.replace(/\p{Emoji_Presentation}/gu, '');

            const emojiSpan = document.createElement('span');
            emojiSpan.textContent = emoji;
            emojiSpan.classList.add('emoji');
            cityButton.appendChild(emojiSpan);

            const cityNameSpan = document.createElement('span');
            cityNameSpan.textContent = cityNameWithoutEmoji;
            cityNameSpan.classList.add('city-name');
            cityButton.appendChild(cityNameSpan);

            cityButton.addEventListener('click', () => {
                handleCityButtonClick(cityInfo);
            });

            return cityButton
        }


        function handleCityButtonClick(cityInfo) {
            const cityId = cityInfo.city_id;

            // Скрыть кнопки городов
            const cityButtonsDiv = document.getElementById('city-buttons');
            cityButtonsDiv.classList.add('hidden');

            // Показывать кнопки жанров
            const genresListDiv = document.getElementById('genres-list');
            genresListDiv.classList.remove('hidden');
            loadAvailableGenres(cityId);
        }

        async function loadAvailableGenres(cityId) {
            try {
                console.log(`Fetching genres for city ${cityId}`);
                const response = await fetch(`/city/${cityId}/genres`);
                console.log(`Response received for genres of city ${cityId}`)
                const availableGenres = await response.json();

                const genresListDiv = document.getElementById('genres-list');
                genresListDiv.innerHTML = '';

                availableGenres.forEach(genre => {
                    const genreButton = createGenreButton(genre);
                    genresListDiv.appendChild(genreButton);
                });
            } catch (error) {
                console.error('Ошибка при получении доступных жанров:', error);
            }
        }

        function createGenreButton(genreInfo) {
            const genreButton = document.createElement('button');
            genreButton.classList.add('genre-button');
            genreButton.addEventListener('click', () => {
                handleGenreButtonClick(genreInfo);
            });

            const emojiMatch = genreInfo.name.match(/(\p{Emoji_Presentation})/gu);
            const emoji = emojiMatch ? emojiMatch[0] : '';
            const genreNameWithoutEmoji = genreInfo.name.replace(/\p{Emoji_Presentation}/gu, '');

            const emojiSpan = document.createElement('span');
            emojiSpan.textContent = emoji;
            emojiSpan.classList.add('emoji');
            genreButton.appendChild(emojiSpan);

            const genreNameSpan = document.createElement('span');
            genreNameSpan.textContent = genreNameWithoutEmoji;
            genreNameSpan.classList.add('genre-name');
            genreButton.appendChild(genreNameSpan);

            return genreButton;
        }


        async function loadAvailableSubgenres(genreId, cityId) {
            try {
                console.log(`Fetching subgenres for genre ${genreId} in city ${cityId}`);
                const response = await fetch(`/city/${cityId}/genre/${genreId}/subgenres`);
                console.log(`Response received for subgenres of genre ${genreId} in city ${cityId}`);
                const availableSubgenres = await response.json();

                const subgenresListDiv = document.getElementById('subgenres-list');
                subgenresListDiv.innerHTML = '';

                availableSubgenres.forEach(subgenre => {
                    const subgenreBlock = createSubgenreBlock(subgenre);
                    subgenresListDiv.appendChild(subgenreBlock);
                });
            } catch (error) {
                console.error('Ошибка при получении доступных поджанров:', error);
            }
        }


        function createSubgenreBlock(subgenreInfo) {
            const subgenreBlock = document.createElement('div');
            subgenreBlock.classList.add('subgenre-block');

            const subgenreName = document.createElement('div');
            subgenreName.textContent = subgenreInfo.name;
            subgenreName.classList.add('subgenre-name');
            subgenreBlock.appendChild(subgenreName);

            const addSubgenreButton = document.createElement('button');
            addSubgenreButton.textContent = '+';
            addSubgenreButton.classList.add('add-subgenre-button');
            addSubgenreButton.addEventListener('click', () => {
                handleAddSubgenreButtonClick(subgenreInfo);
            });
            subgenreBlock.appendChild(addSubgenreButton);

            return subgenreBlock;
        }

        function handleAddSubgenreButtonClick(subgenreInfo) {
            console.log('Добавлен поджанр:', subgenreInfo.name);
        }


        function handleGenreButtonClick(genre) {
            console.log('Genre button clicked:', genre.name);
        }


        let tg = window.Telegram.WebApp;
        tg.expand();
        
        // tg.sendData(JSON.stringify(data));
        // tg.close();

    </script>

</body>
</html>